<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>BoxChat</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Legacy context menu styles */
        .context-menu {
            position: fixed;
            background: var(--bg-panel);
            border-radius: var(--radius-sm);
            padding: 4px;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.24);
            z-index: 10004;
            display: none;
            border: 1px solid var(--border);
        }
        .context-menu-item {
            padding: 8px 12px;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 2px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.15s;
        }
        .context-menu-item:hover {
            background: var(--primary);
            color: var(--bg-dark);
        }
        .context-menu-item.danger:hover {
            background: var(--danger);
            color: white;
        }
        .context-menu-separator {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }
    </style>
</head>
<body>
    <div class="chat-layout">
    <div class="sidebar">
        <a href="{{ url_for('main.dashboard') }}" class="nav-item" title="Dashboard">
            <div class="icon-circle">
                <span class="material-icons-round">person</span>
            </div>
            <span id="dashboardUnreadBadge" style="display:none; position:absolute; right:6px; top:6px; background:var(--danger); color:#fff; border-radius:10px; padding:2px 6px; font-size:0.75rem; font-weight:700;"></span>
        </a>
        <a href="{{ url_for('main.explore') }}" class="nav-item" title="Explore">
            <div class="icon-circle">
                <span class="material-icons-round">explore</span>
            </div>
        </a>
        <hr style="width: 40%; border: 0; border-top: 1px solid var(--border); margin: 10px 0;">
        
        {% for s in current_user.memberships %}
            {% if s.room and s.room.type != 'dm' %}
            <a href="{{ url_for('main.view_room', room_id=s.room.id) }}" class="nav-item sidebar-server" data-room-id="{{ s.room.id }}" data-role="{{ s.role }}" title="{{ s.room.name }}">
                <div class="icon-circle">
                    {% if s.room.avatar_url %}
                        <img src="{{ s.room.avatar_url }}" alt="{{ s.room.name }}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">
                    {% else %}
                        {{ s.room.name[:2] }}
                    {% endif %}
                </div>
            </a>
            {% endif %}
        {% endfor %}
        
        <hr style="width: 50%; border: 0; border-top: 1px solid var(--border); margin: 8px 0;">
        
        <button class="nav-item" onclick="showCreateRoomModal(); return false;" style="background: none; border: none; cursor: pointer;" title="Create Room">
            <div class="icon-circle">
                <span class="material-icons-round">add_circle</span>
            </div>
        </button>
        
        <div id="stickerPacksContainer" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px;">
            <!-- Stickerpack icons will be added here -->
        </div>
        
        <button class="nav-item" onclick="showCreateStickerPackModal(); return false;" style="background: none; border: none; cursor: pointer;" title="Create Stickerpack">
            <div class="icon-circle">
                <span class="material-icons-round">collections</span>
            </div>
        </button>
        
        <div style="flex: 1; display: flex; flex-direction: column; gap: 10px; overflow-y: auto;">
        </div>
        
        <hr style="width: 50%; border: 0; border-top: 1px solid var(--border); margin: 8px 0;">
        
        <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 8px 0;">
            <a href="{{ url_for('api.settings') }}" class="nav-item" title="Settings">
                <div class="icon-circle">
                    <span class="material-icons-round">settings</span>
                </div>
            </a>
            <a href="{{ url_for('auth.logout') }}" class="nav-item" title="Logout">
                <div class="icon-circle" style="background: var(--danger);">
                    <span class="material-icons-round">logout</span>
                </div>
            </a>
        </div>
    </div>

    <!-- Flash messages Modal -->
    <div class="modal-overlay" id="flashMessageModal" style="z-index: 10100;">
        <div class="modal">
            <div class="modal-header" id="flashMessageTitle">Alert</div>
            <div class="modal-body" id="flashMessageBody"></div>
            <div class="modal-footer">
                <button class="btn btn-login" onclick="closeFlashModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <script>
                (function() {
                    const messages = {{ messages | tojson }};
                    const message = messages[0]; // Show first message
                    
                    function showFlashModal(text) {
                        const modal = document.getElementById('flashMessageModal');
                        const body = document.getElementById('flashMessageBody');
                        const title = document.getElementById('flashMessageTitle');
                        
                        if (text.toLowerCase().includes('banned')) {
                            title.textContent = 'üö´ Banned';
                        } else {
                            title.textContent = 'Alert';
                        }
                        
                        body.textContent = text;
                        if (modal) modal.style.display = 'flex';
                    }
                    
                    function closeFlashModal() {
                        const modal = document.getElementById('flashMessageModal');
                        if (modal) modal.style.display = 'none';
                    }
                    
                    // Wait a moment for DOM to be ready, then show
                    setTimeout(() => {
                        showFlashModal(message);
                    }, 100);
                    
                    // Make closeFlashModal available globally
                    window.closeFlashModal = closeFlashModal;
                })();
            </script>
        {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
    </div>

<script>
// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∏–∫–µ—Ä–ø–∞–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function loadStickerPacks() {
    fetch('/stickerpacks')
    .then(r => r.json())
    .then(data => {
        const container = document.getElementById('stickerPacksContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        data.packs.forEach(pack => {
            const packIcon = document.createElement('div');
            packIcon.className = 'server-icon';
            packIcon.title = pack.name;
            packIcon.textContent = pack.icon_emoji || 'üì¶';
            packIcon.onclick = () => {
                if (typeof showStickerPack === 'function') {
                    showStickerPack(pack.id, pack.name);
                }
            };
            packIcon.style.cursor = 'pointer';
            packIcon.style.position = 'relative';
            
            // –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
            const editBtn = document.createElement('button');
            editBtn.textContent = '‚úèÔ∏è';
            editBtn.style.position = 'absolute';
            editBtn.style.top = '-5px';
            editBtn.style.right = '-5px';
            editBtn.style.background = '#5865f2';
            editBtn.style.border = 'none';
            editBtn.style.borderRadius = '50%';
            editBtn.style.width = '20px';
            editBtn.style.height = '20px';
            editBtn.style.fontSize = '10px';
            editBtn.style.cursor = 'pointer';
            editBtn.style.display = 'none';
            editBtn.onclick = (e) => {
                e.stopPropagation();
                if (typeof editStickerPack === 'function') {
                    editStickerPack(pack.id, pack.name, pack.icon_emoji);
                }
            };
            packIcon.onmouseenter = () => editBtn.style.display = 'block';
            packIcon.onmouseleave = () => editBtn.style.display = 'none';
            packIcon.appendChild(editBtn);
            
            container.appendChild(packIcon);
        });
    });
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∏–∫–µ—Ä–ø–∞–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadStickerPacks);
} else {
    loadStickerPacks();
}

function showCreateStickerPackModal() {
    document.getElementById('createStickerPackModal').style.display = 'flex';
}

function submitCreateStickerPack(e) {
    e.preventDefault();
    const name = document.getElementById('packName').value;
    const emoji = document.getElementById('packEmoji').value || 'üì¶';
    
    if (!name) {
        showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∏–∫–µ—Ä–ø–∞–∫–∞');
        return;
    }
    
    fetch('/stickerpack/create', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: name, icon_emoji: emoji})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadStickerPacks();
            closeModal('createStickerPackModal');
            if (typeof showAlert === 'function') {
                showAlert('–°—Ç–∏–∫–µ—Ä–ø–∞–∫ —Å–æ–∑–¥–∞–Ω!');
            } else {
                alert('–°—Ç–∏–∫–µ—Ä–ø–∞–∫ —Å–æ–∑–¥–∞–Ω!');
            }
            document.getElementById('packName').value = '';
            document.getElementById('packEmoji').value = 'üì¶';
        } else {
            if (typeof showAlert === 'function') {
                showAlert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        }
    });
}

function showCreateRoomModal() {
    document.getElementById('createRoomModal').style.display = 'flex';
}

function submitCreateRoom(e) {
    e.preventDefault();
    const name = document.getElementById('roomName').value;
    const type = document.getElementById('roomType').value;
    const isPublic = document.getElementById('roomPublic').checked;
    
    if (!name) {
        showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã');
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/create_room';
    const nameInput = document.createElement('input');
    nameInput.type = 'hidden';
    nameInput.name = 'name';
    nameInput.value = name;
    form.appendChild(nameInput);
    const typeInput = document.createElement('input');
    typeInput.type = 'hidden';
    typeInput.name = 'type';
    typeInput.value = type;
    form.appendChild(typeInput);
    if (isPublic) {
        const publicInput = document.createElement('input');
        publicInput.type = 'hidden';
        publicInput.name = 'is_public';
        publicInput.value = 'on';
        form.appendChild(publicInput);
    }
    document.body.appendChild(form);
    form.submit();
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay
document.addEventListener('DOMContentLoaded', function() {
    ['createRoomModal', 'createStickerPackModal', 'editStickerPackModal'].forEach(id => {
        const modal = document.getElementById(id);
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === this) closeModal(id);
            });
        }
    });
    
    // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ sidebar
    let sidebarContextMenuServerId = null;
    let sidebarContextMenuServerRole = null;
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è sidebar
    const sidebarContextMenu = document.createElement('div');
    sidebarContextMenu.id = 'sidebarServerContextMenu';
    sidebarContextMenu.className = 'context-menu';
    sidebarContextMenu.style.cssText = 'position: fixed; background: #18191c; border-radius: 4px; padding: 4px; min-width: 200px; box-shadow: 0 8px 16px rgba(0,0,0,0.24); z-index: 10004; display: none;';
    sidebarContextMenu.innerHTML = `
        <div class="context-menu-item" onclick="sidebarInviteToServer()">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</div>
        <div class="context-menu-separator" id="sidebarMenuSeparator" style="height: 1px; background: #4f545c; margin: 4px 0;"></div>
        <div class="context-menu-item danger" onclick="sidebarDeleteServer()">–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</div>
        <div class="context-menu-item danger" onclick="sidebarLeaveServer()">–ü–æ–∫–∏–Ω—É—Ç—å —Å–µ—Ä–≤–µ—Ä</div>
    `;
    document.body.appendChild(sidebarContextMenu);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ü–ö–ú –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ã –≤ sidebar - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
    document.addEventListener('contextmenu', function(e) {
        const serverItem = e.target.closest('.sidebar-server');
        if (serverItem) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            sidebarContextMenuServerId = parseInt(serverItem.dataset.roomId);
            sidebarContextMenuServerRole = serverItem.dataset.role;
            
            const menu = document.getElementById('sidebarServerContextMenu');
            if (!menu) return;
            
            menu.style.display = 'block';
            menu.style.left = Math.min(e.clientX, window.innerWidth - 220) + 'px';
            menu.style.top = Math.min(e.clientY, window.innerHeight - 200) + 'px';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø—É–Ω–∫—Ç—ã –º–µ–Ω—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
            const canInvite = sidebarContextMenuServerRole === 'owner' || sidebarContextMenuServerRole === 'admin';
            const canDelete = sidebarContextMenuServerRole === 'owner' || sidebarContextMenuServerRole === 'admin';
            const canLeave = sidebarContextMenuServerRole !== 'owner';
            
            const menuItems = menu.querySelectorAll('.context-menu-item');
            const separator = document.getElementById('sidebarMenuSeparator');
            
            if (menuItems[0]) menuItems[0].style.display = canInvite ? 'flex' : 'none'; // –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å
            if (menuItems[1]) menuItems[1].style.display = canDelete ? 'flex' : 'none'; // –£–¥–∞–ª–∏—Ç—å
            if (menuItems[2]) menuItems[2].style.display = canLeave ? 'flex' : 'none'; // –ü–æ–∫–∏–Ω—É—Ç—å
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –æ–±–µ –∫–Ω–æ–ø–∫–∏ (—É–¥–∞–ª–∏—Ç—å –ò –ø–æ–∫–∏–Ω—É—Ç—å)
            if (separator) {
                separator.style.display = (canDelete && canLeave) ? 'block' : 'none';
            }
        }
    }, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è —Ä–∞–Ω—å—à–µ
    
    document.addEventListener('click', function(e) {
        const menu = document.getElementById('sidebarServerContextMenu');
        if (menu && !menu.contains(e.target)) {
            menu.style.display = 'none';
        }
    });
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è sidebar –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
    window.sidebarInviteToServer = function() {
        if (!sidebarContextMenuServerId) return;
        fetch(`/room/${sidebarContextMenuServerId}/invite`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                navigator.clipboard.writeText(data.invite_url).then(() => {
                    if (typeof showAlert === 'function') {
                        showAlert('–°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                    } else {
                        alert('–°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                    }
                }).catch(() => {
                    // Fallback
                    const textarea = document.createElement('textarea');
                    textarea.value = data.invite_url;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        if (typeof showAlert === 'function') {
                            showAlert('–°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                        } else {
                            alert('–°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                        }
                    } catch (err) {
                        if (typeof showAlert === 'function') {
                            showAlert('–°—Å—ã–ª–∫–∞: ' + data.invite_url);
                        } else {
                            alert('–°—Å—ã–ª–∫–∞: ' + data.invite_url);
                        }
                    }
                    document.body.removeChild(textarea);
                });
            } else {
                if (typeof showAlert === 'function') {
                    showAlert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            }
        });
        const menu = document.getElementById('sidebarServerContextMenu');
        if (menu) menu.style.display = 'none';
    };
    
    window.sidebarDeleteServer = function() {
        if (!sidebarContextMenuServerId) return;
        const confirmMsg = '–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.';
        if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä\n\n' + confirmMsg)) {
            fetch(`/room/${sidebarContextMenuServerId}/delete`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    window.location.href = "{{ url_for('main.dashboard') }}";
                } else {
                    if (typeof showAlert === 'function') {
                        showAlert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                }
            });
        }
        const menu = document.getElementById('sidebarServerContextMenu');
        if (menu) menu.style.display = 'none';
    };
    
    window.sidebarLeaveServer = function() {
        if (!sidebarContextMenuServerId) return;
        if (confirm('–ü–æ–∫–∏–Ω—É—Ç—å —Å–µ—Ä–≤–µ—Ä\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —ç—Ç–æ—Ç —Å–µ—Ä–≤–µ—Ä?')) {
            fetch(`/room/${sidebarContextMenuServerId}/leave`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    window.location.href = "{{ url_for('main.dashboard') }}";
                } else {
                    if (typeof showAlert === 'function') {
                        showAlert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                }
            });
        }
        const menu = document.getElementById('sidebarServerContextMenu');
        if (menu) menu.style.display = 'none';
    };
});
</script>
<script>
// Personal notification socket (separate from page socket instances)
try {
    const notifSocket = (typeof io !== 'undefined') ? io() : null;
    let globalUnread = 0;

    function showBadge(count) {
        const el = document.getElementById('dashboardUnreadBadge');
        if (!el) return;
        if (count && count > 0) {
            el.style.display = 'inline-block';
            el.textContent = count > 99 ? '99+' : String(count);
        } else {
            el.style.display = 'none';
        }
    }
    // expose globally so other pages/scripts can clear/update the badge
    window.showBadge = showBadge;
    window.clearDashboardBadge = function() { globalUnread = 0; showBadge(0); };

    if (notifSocket) {
        notifSocket.on('connect', function() {
            try { notifSocket.emit('join', {channel_id: null}); } catch (e) {}
            // request notification permission once
            if (window.Notification && Notification.permission === 'default') {
                try { Notification.requestPermission().then(() => {}); } catch(e) {}
            }
        });

        notifSocket.on('message_notification', function(data) {
            try {
                // Update dashboard badge when off-dashboard
                globalUnread = (globalUnread || 0) + 1;
                showBadge(globalUnread);

                // Show browser notification if page not focused or not viewing that channel
                const title = data.from_user || 'New message';
                const body = data.snippet || 'New message';
                if (window.Notification && Notification.permission === 'granted') {
                    try {
                        const n = new Notification(title, { body: body, icon: '/static/img/logo-192.png' });
                        n.onclick = function() {
                            window.focus();
                            // navigate to dashboard by default so user can reach message
                            window.location.href = '/';
                        };
                    } catch (e) { console.error('Notification failed', e); }
                }
            } catch (e) { console.error('message_notification handler failed', e); }
        });

        // Legacy handler for dashboard list updates
        notifSocket.on('new_dm_message', function(data) {
            try {
                // increment unread summary badge
                globalUnread = (globalUnread || 0) + 1;
                showBadge(globalUnread);
            } catch (e) {}
        });
    }
} catch (e) { console.error('notif socket init failed', e); }
</script>
<style>
.context-menu {
    position: fixed;
    background: #18191c;
    border-radius: 4px;
    padding: 4px;
    min-width: 200px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.24);
    z-index: 10004;
    display: none;
}
.context-menu-item {
    padding: 8px 12px;
    color: #b9bbbe;
    cursor: pointer;
    border-radius: 2px;
    font-size: 0.9em;
    display: flex;
    align-items: center;
    gap: 8px;
}
.context-menu-item:hover {
    background: #5865f2;
    color: white;
}
.context-menu-item.danger:hover {
    background: #d83c3e;
}
.context-menu-separator {
    height: 1px;
    background: #4f545c;
    margin: 4px 0;
}
</style>
</script>

<!-- Modal: Create Room -->
<div class="modal-overlay" id="createRoomModal">
    <div class="modal">
        <div class="modal-header">Create Server</div>
        <form id="createRoomForm" onsubmit="submitCreateRoom(event); return false;">
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Server Name</label>
                    <input type="text" id="roomName" class="custom-input" required>
                </div>
                <div class="input-group">
                    <label class="input-label">Type</label>
                    <select id="roomType" class="custom-input">
                        <option value="server">Server (with channels)</option>
                        <option value="broadcast">Blog (read-only)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(167, 139, 250, 0.1); border-radius: var(--radius-sm); cursor: pointer; margin: 0;">
                        <input type="checkbox" id="roomPublic" style="cursor: pointer; width: 18px; height: 18px;">
                        <span style="font-size: 0.95rem;">Public (visible in search)</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createRoomModal')">Cancel</button>
                <button type="submit" class="btn btn-login">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: Create Stickerpack -->
<div class="modal-overlay" id="createStickerPackModal">
    <div class="modal">
        <div class="modal-header">Create Stickerpack</div>
        <form id="createStickerPackForm" onsubmit="submitCreateStickerPack(event); return false;">
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Stickerpack Name:</label>
                    <input type="text" id="packName" class="custom-input" required>
                </div>
                <div class="input-group">
                    <label class="input-label">Icon Emoji:</label>
                    <input type="text" id="packEmoji" class="custom-input" value="üì¶" maxlength="2">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createStickerPackModal')">Cancel</button>
                <button type="submit" class="btn btn-login">Create Stickerpack</button>
            </div>
        </form>
    </div>
</div>
</body>
</html>
