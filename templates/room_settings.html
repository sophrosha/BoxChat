{% extends "base.html" %}
{% block content %}
<div class="chat-area" style="display: flex; flex-direction: column; overflow-y: auto; grid-column: 2 / 4 !important;">
    <div style="padding: 40px;">
        <div style="max-width: 600px; margin: 0 auto;">
            <h1 style="font-size: 2rem; font-weight: 700; color: var(--text-main); margin-bottom: 32px;">Server Settings</h1>
            
            <div class="card">
                <form method="POST" enctype="multipart/form-data">
                    <div class="input-group">
                        <label class="input-label">Server Name</label>
                        <input type="text" name="name" value="{{ room.name }}" class="custom-input" required>
                    </div>
                    
                    <div style="margin: 24px 0; text-align: center;">
                        {% if room.avatar_url %}
                        <img src="{{ room.avatar_url }}" id="avatarPreview" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 14px; cursor: pointer; border: 3px solid var(--border);" onclick="document.getElementById('avatar_file').click();">
                        {% else %}
                        <div id="avatarPreview" style="width: 120px; height: 120px; border-radius: 50%; background: var(--bg-panel); display: flex; align-items: center; justify-content: center; margin: 0 auto 14px; cursor: pointer; border: 3px solid var(--border);">
                            <span class="material-icons-round" style="font-size: 56px; color: var(--text-muted);">public</span>
                        </div>
                        {% endif %}
                        <br>
                        <input type="file" name="avatar_file" id="avatar_file" accept="image/png,image/jpeg,image/gif,image/webp,image/svg+xml" style="display: none;" onchange="previewAvatar(this);">
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 14px;">
                            <button type="button" class="btn btn-login" onclick="document.getElementById('avatar_file').click();">Upload Server Icon</button>
                            {% if room.avatar_url %}
                            <button type="button" class="btn" style="background: var(--danger); color: var(--text-main);" onclick="deleteRoomAvatar('{{ room.id }}');">Delete Icon</button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button type="submit" class="btn btn-login" style="flex: 1;">Save Changes</button>
                        <a href="{{ url_for('main.view_room', room_id=room.id) }}" class="btn btn-secondary" style="flex: 1; text-decoration: none; text-align: center; display: flex; align-items: center; justify-content: center;">Cancel</a>
                    </div>
                </form>
            </div>
            
            <div class="card" style="margin-top: 18px;">
                <h3 style="margin-top: 0;">Banned members</h3>
                {% if room_bans|length > 0 %}
                <div style="display:flex; flex-direction:column; gap:8px;">
                    {% for ban in room_bans %}
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px; border:1px solid var(--border); border-radius:6px; background: var(--bg-panel);">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <img src="{{ ban.user.avatar_url or 'https://via.placeholder.com/40' }}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
                            <div>
                                <div style="font-weight:600;">{{ ban.user.username }}</div>
                                <div style="font-size:0.85rem;color:var(--text-muted);">Banned</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn" onclick="unbanFromRoom({{ ban.user.id }}, {{ room.id }});">Unban</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div style="color: var(--text-muted);">No banned members</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
function previewAvatar(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('avatarPreview').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function deleteRoomAvatar(roomId) {
    if (typeof window.showConfirm === 'function') {
        window.showConfirm('Delete Icon', 'Delete server icon?', function() {
    
            fetch(`/room/${roomId}/avatar/delete`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    if (typeof window.showAlert === 'function') {
                        window.showAlert('Error', data.error || 'Unknown error');
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                }
            });
        }, 'Delete', 'danger');
    } else {
        if (!confirm('Delete server icon?')) return;
        fetch(`/room/${roomId}/avatar/delete`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        });
    }
}
</script>
<script>
function unbanFromRoom(userId, roomId) {
    if (typeof window.showConfirm === 'function') {
        window.showConfirm('Unban User', 'Unban this user from the room?', function() {
            fetch(`/admin/user/${userId}/unban`, {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({room_id: roomId})})
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    location.reload();
                } else {
                    if (typeof window.showAlert === 'function') {
                        window.showAlert('Error', res.error || res.message || 'Error');
                    } else {
                        alert(res.error || res.message || 'Error');
                    }
                }
            });
        }, 'Unban', 'danger');
    } else {
        if (!confirm('Unban this user from the room?')) return;
        fetch(`/admin/user/${userId}/unban`, {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({room_id: roomId})})
        .then(r => r.json())
        .then(res => {
            if (res.success) {
                location.reload();
            } else {
                alert(res.error || res.message || 'Error');
            }
        });
    }
}
</script>
{% endblock %}

