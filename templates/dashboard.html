{% extends "base.html" %}
{% block content %}
<style>
    .unread-badge {
        background: var(--danger);
        color: white;
        border-radius: 12px;
        padding: 2px 6px;
        font-size: 0.75rem;
        min-width: 20px;
        text-align: center;
        font-weight: 700;
    }
    .dm-item, .server-item {
        display: flex !important;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: var(--radius-sm);
        margin: 3px 8px;
        cursor: pointer;
        transition: 0.15s;
    }
    .dm-item:hover, .server-item:hover { background-color: var(--bg-surface); }
    .dm-item.active, .server-item.active { background-color: var(--bg-surface); }
    
    /* Mobile responsive - dashboard takes full width */
    @media (max-width: 480px) {
        .chat-area {
            grid-column: 1 / 2 !important;
        }
    }
</style>

<div class="chat-area dashboard-content">
    <div style="padding: 20px 12px; border-bottom: 1px solid var(--border); background-color: var(--bg-panel);">
        <h2 style="margin-bottom: 5px;">Welcome!</h2>
        <p style="color: var(--text-muted); font-size: 0.9rem;">Select a server or start a conversation</p>
    </div>
    <div style="padding: 15px 8px; flex: 1; overflow-y: auto;">
        <div style="padding: 15px;">
        <!-- Direct Messages -->
        <div style="margin-top: 12px; margin-bottom: 16px;">
            <div class="channel-section-title">Direct Messages</div>
            <div id="dmList">
                {% for dm_info in dms %}
                    <a href="{{ url_for('main.view_room', room_id=dm_info.room.id) }}" class="dm-item" data-room-id="{{ dm_info.room.id }}" style="border-bottom: 1px solid var(--border);">
                        {% if dm_info.other_user %}
                            {% if dm_info.other_user.avatar_url and dm_info.other_user.avatar_url != "https://via.placeholder.com/50" %}
                                <img src="{{ dm_info.other_user.avatar_url }}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 1px solid var(--border);">
                            {% else %}
                                <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--bg-panel); display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 1px solid var(--border);">
                                    <span class="material-icons-round" style="font-size: 20px; color: var(--text-muted);">person</span>
                                </div>
                            {% endif %}
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; font-size: 0.95rem;">{{ dm_info.other_user.username }}</div>
                            </div>
                            {% if dm_info.unread_count > 0 %}
                                <span class="unread-badge">{{ dm_info.unread_count }}</span>
                            {% endif %}
                        {% else %}
                            <span style="color: var(--text-muted);">Unknown user</span>
                        {% endif %}
                    </a>
                {% endfor %}
            </div>
        </div>
        
        <!-- Servers/Rooms -->
        <div style="margin-top: 16px; margin-bottom: 16px;">
            <div class="channel-section-title">Servers</div>
            <div>
                {% for server_info in servers %}
                    <a href="{{ url_for('main.view_room', room_id=server_info.room.id) }}" class="server-item" data-room-id="{{ server_info.room.id }}" data-role="{{ server_info.role }}" style="border-bottom: 1px solid var(--border);">
                        {% if server_info.room.avatar_url %}
                            <img src="{{ server_info.room.avatar_url }}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 1px solid var(--border);">
                        {% else %}
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--bg-panel); display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 700; color: var(--text-main); flex-shrink: 0; border: 1px solid var(--border);">
                                {% if server_info.room.name|length > 0 %}
                                    {{ server_info.room.name[:2] }}
                                {% else %}
                                    <span class="material-icons-round" style="font-size: 20px;">public</span>
                                {% endif %}
                            </div>
                        {% endif %}
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 0.95rem;">{{ server_info.room.name }}</div>
                        </div>
                    </a>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Context Menu for DMs -->
    <div id="dmContextMenu" class="context-menu" style="display: none;">
        <div class="context-menu-item danger" onclick="deleteDM()">Delete conversation</div>
    </div>
    
    <!-- Контекстное меню для сервера -->
    <div id="serverContextMenu" class="context-menu" style="display: none;">
        <div class="context-menu-item" onclick="inviteToServer()">Пригласить</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item danger" onclick="deleteServer()">Удалить сервер</div>
        <div class="context-menu-item danger" onclick="leaveServer()">Покинуть сервер</div>
    </div>
    
<script>
let contextMenuServerId = null;
let contextMenuServerRole = null;

let contextMenuDMId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Обработчик ПКМ на серверы
    document.querySelectorAll('.server-item').forEach(item => {
        item.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            e.stopPropagation();
            contextMenuServerId = parseInt(this.dataset.roomId);
            contextMenuServerRole = this.dataset.role;
            
            const menu = document.getElementById('serverContextMenu');
            menu.style.display = 'block';
            menu.style.left = Math.min(e.clientX, window.innerWidth - 220) + 'px';
            menu.style.top = Math.min(e.clientY, window.innerHeight - 200) + 'px';
            
            // Показываем/скрываем пункты меню в зависимости от роли
            const canInvite = contextMenuServerRole === 'owner' || contextMenuServerRole === 'admin';
            const canDelete = contextMenuServerRole === 'owner' || contextMenuServerRole === 'admin';
            const items = menu.querySelectorAll('.context-menu-item');
            if (items[0]) items[0].style.display = canInvite ? 'flex' : 'none'; // Пригласить
            // items[1] => Удалить, items[2] => Покинуть
            if (items[1]) items[1].style.display = canDelete ? 'flex' : 'none'; // Удалить (only owners/admins)
            if (items[2]) items[2].style.display = contextMenuServerRole !== 'owner' ? 'flex' : 'none'; // Покинуть (hide for owner)
        });
    });
    
    // Обработчик ПКМ на ЛС
    document.querySelectorAll('.dm-item').forEach(item => {
        item.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            e.stopPropagation();
            contextMenuDMId = parseInt(this.dataset.roomId);
            
            const menu = document.getElementById('dmContextMenu');
            menu.style.display = 'block';
            menu.style.left = Math.min(e.clientX, window.innerWidth - 220) + 'px';
            menu.style.top = Math.min(e.clientY, window.innerHeight - 200) + 'px';
        });
    });
    
    document.addEventListener('click', function() {
        document.getElementById('serverContextMenu').style.display = 'none';
        document.getElementById('dmContextMenu').style.display = 'none';
    });
});

function deleteServer() {
    if (!contextMenuServerId) return;
    showConfirm('Удалить сервер', 'Вы уверены? Все данные сервера будут удалены безвозвратно.', () => {
        fetch(`/room/${contextMenuServerId}/delete`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                window.location.href = "{{ url_for('main.dashboard') }}";
            } else {
                showAlert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
            }
        });
    });
    document.getElementById('serverContextMenu').style.display = 'none';
}

function leaveServer() {
    if (!contextMenuServerId) return;
    showConfirm('Покинуть сервер', 'Вы уверены, что хотите покинуть этот сервер?', () => {
        fetch(`/room/${contextMenuServerId}/leave`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                window.location.href = "{{ url_for('main.dashboard') }}";
            } else {
                showAlert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
            }
        });
    });
    document.getElementById('serverContextMenu').style.display = 'none';
}

function inviteToServer() {
    if (!contextMenuServerId) return;
    fetch(`/room/${contextMenuServerId}/invite`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            navigator.clipboard.writeText(data.invite_url).then(() => {
                showAlert('Ссылка-приглашение скопирована в буфер обмена!');
            }).catch(() => {
                // Fallback если clipboard API не работает
                const textarea = document.createElement('textarea');
                textarea.value = data.invite_url;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showAlert('Ссылка-приглашение скопирована в буфер обмена!');
                } catch (err) {
                    showAlert('Ссылка: ' + data.invite_url);
                }
                document.body.removeChild(textarea);
            });
        } else {
            showAlert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    });
    document.getElementById('serverContextMenu').style.display = 'none';
}

function deleteDM() {
    if (!contextMenuDMId) return;
    showConfirm('Удалить переписку', 'Вы уверены, что хотите удалить эту переписку?', () => {
        fetch(`/room/${contextMenuDMId}/delete_dm`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                showAlert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
            }
        });
    });
    document.getElementById('dmContextMenu').style.display = 'none';
}

// Функции для модальных окон
function showAlert(message) {
    alert(message); // Временно используем стандартный alert
}

function showConfirm(title, message, onConfirm) {
    if (confirm(title + '\n\n' + message)) {
        onConfirm();
    }
}
</script>

<script src="/static/js/socket.io.js"></script>
<script>
// Подключаемся к Socket.IO для обновления списка ЛС в реальном времени
const socket = io();

// Подключаемся к персональной комнате
socket.on('connect', function() {
    socket.emit('join', {channel_id: null}); // Для персональной комнаты
});

// Обработчик нового ЛС
socket.on('new_dm_created', function(data) {
    // Обновляем страницу или добавляем новый элемент в список
    location.reload(); // Пока просто обновляем страницу
});

// Обработчик нового сообщения в ЛС
socket.on('new_dm_message', function(data) {
    // Обновляем счётчик непрочитанных или добавляем новый ЛС в список
    const dmItem = document.querySelector(`.dm-item[data-room-id="${data.room_id}"]`);
    if (dmItem) {
        // Обновляем счётчик непрочитанных
        let badge = dmItem.querySelector('.unread-badge');
        if (badge) {
            badge.textContent = parseInt(badge.textContent) + 1;
        } else {
            badge = document.createElement('span');
            badge.className = 'unread-badge';
            badge.style.cssText = 'background: #f04747; color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.75em; min-width: 18px; text-align: center;';
            badge.textContent = '1';
            dmItem.appendChild(badge);
        }
        // Перемещаем наверх
        const dmList = document.getElementById('dmList');
        if (dmList) {
            dmList.insertBefore(dmItem, dmList.firstChild);
        }
    } else {
        // Новый ЛС - обновляем страницу
        location.reload();
    }
});

// When a server is removed for this user (e.g. they were banned), remove it from the list
socket.on('server_removed', function(data) {
    try {
        if (!data || !data.room_id) return;
        const rid = String(data.room_id);
        const el = document.querySelector(`.server-item[data-room-id="${rid}"]`);
        if (el) el.remove();
        // If currently viewing that room, redirect to dashboard
        try {
            const pathParts = window.location.pathname.split('/');
            if (pathParts.includes('room') && pathParts.includes(rid)) {
                window.location.href = "{{ url_for('main.dashboard') }}";
            }
        } catch (e) {}
    } catch (e) { console.error('server_removed handler error', e); }
});

// When banned, force redirect to dashboard
socket.on('force_redirect', function(data) {
    try {
        const loc = (data && data.location) ? data.location : "/";
        if (loc) {
            // Immediately redirect without alert
            window.location = loc;
        }
    } catch (e) { console.error('force_redirect handler error', e); }
});
</script>
        </div>
    </div>
</div>
<script>
    // Добавляем класс, чтобы CSS знал, что мы на главной
    document.body.classList.add('is-dashboard');
</script>
{% endblock %}